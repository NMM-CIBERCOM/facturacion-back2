# üîß Soluci√≥n: "C√≥digo de verificaci√≥n inv√°lido"

## üö® Problema Identificado

El c√≥digo `681718` est√° siendo rechazado como inv√°lido. Esto puede ser por:

1. **Clave Base32 incorrecta en la base de datos**
2. **Desincronizaci√≥n de tiempo entre Google Authenticator y el servidor**
3. **Problema con la implementaci√≥n del backend**

## ‚ö° Soluci√≥n Paso a Paso

### **Paso 1: Diagnosticar la base de datos**
```sql
-- Ejecutar en Oracle SQL Developer
@database_diagnose_2fa.sql
```

**Verificar que muestre:**
- ‚úÖ **LONGITUD**: `32`
- ‚úÖ **VALIDACION_LONGITUD**: `‚úÖ LONGITUD CORRECTA (32)`
- ‚úÖ **VALIDACION_FORMATO**: `‚úÖ FORMATO BASE32 V√ÅLIDO`

### **Paso 2: Verificar Google Authenticator**

1. **Abrir Google Authenticator**
2. **Verificar que la cuenta `Cibercom - admin` est√© configurada**
3. **Verificar que el c√≥digo de 6 d√≠gitos est√© cambiando cada 30 segundos**
4. **Si no est√° configurada, agregarla con la clave de 32 caracteres**

### **Paso 3: Probar con c√≥digo m√°s reciente**

El c√≥digo TOTP cambia cada 30 segundos. Aseg√∫rate de usar el c√≥digo m√°s reciente:

```bash
# Esperar a que aparezca un nuevo c√≥digo en Google Authenticator
curl -X POST "http://localhost:8080/api/auth/2fa/enable?username=admin&code=NUEVO_CODIGO"
```

### **Paso 4: Verificar sincronizaci√≥n de tiempo**

Si el problema persiste, puede ser desincronizaci√≥n de tiempo:

```bash
# Verificar que el servidor est√© sincronizado
curl -X GET "http://localhost:8080/api/auth/2fa/health"
```

### **Paso 5: Probar con c√≥digo manual**

Si Google Authenticator no funciona, prueba con un c√≥digo manual:

```bash
# Usar c√≥digo de prueba (solo para testing)
curl -X POST "http://localhost:8080/api/auth/2fa/enable?username=admin&code=123456"
```

## üîç Verificaciones Adicionales

### **1. Verificar que el backend est√© funcionando:**
```bash
# Verificar endpoint de setup
curl -X POST "http://localhost:8080/api/auth/2fa/setup?username=admin"
```

### **2. Verificar logs del backend:**
- Revisar la consola del backend para errores
- Verificar que no haya excepciones en la verificaci√≥n TOTP

### **3. Verificar configuraci√≥n de tiempo:**
- Asegurarse de que el servidor tenga la hora correcta
- Verificar que no haya diferencia de m√°s de 30 segundos

## üö® Soluci√≥n Alternativa

Si el problema persiste, podemos deshabilitar temporalmente el 2FA:

```sql
-- Deshabilitar 2FA temporalmente
UPDATE USUARIOS 
SET TWO_FACTOR_ENABLED = 'N'
WHERE NO_USUARIO = 'admin';
COMMIT;
```

## üì± Pasos para Reconfigurar Google Authenticator

1. **Eliminar la cuenta existente** en Google Authenticator
2. **Ejecutar el script de diagn√≥stico** para obtener la clave correcta
3. **Agregar nueva cuenta** con la clave de 32 caracteres
4. **Probar con el nuevo c√≥digo**

---

**¬°Ejecuta primero el script de diagn√≥stico para verificar el estado de la clave!**
