# üîß Instrucciones de Instalaci√≥n - Sistema de Seguridad

## ‚úÖ Problemas Solucionados

### 1. **Errores de Permisos en Oracle Database**
Los errores que obtuviste son normales y no afectan la funcionalidad principal:

```
ORA-01031: privilegios insuficientes
```

**Causa**: Algunos elementos requieren privilegios de administrador de base de datos.

**Soluci√≥n**: He creado scripts separados para diferentes niveles de permisos.

### 2. **Errores en UsuarioService.java**
- ‚úÖ Corregido m√©todo `getPassword()` inexistente
- ‚úÖ Corregido warning de m√©todo deprecated
- ‚úÖ Limpiados imports no utilizados

## üìã Instrucciones de Instalaci√≥n Paso a Paso

### **Paso 1: Script Principal (Sin Privilegios Especiales)**
```sql
-- Ejecutar este script primero
@database_security_setup_simple.sql
```

**Este script crea:**
- ‚úÖ Tabla `USER_PAYMENT_STATUS`
- ‚úÖ Columnas adicionales en `USUARIOS`
- ‚úÖ √çndices para rendimiento
- ‚úÖ Usuario Super Admin inicial
- ‚úÖ Trigger para actualizaci√≥n autom√°tica
- ‚úÖ Funci√≥n de verificaci√≥n de acceso

### **Paso 2: Script de Administrador (Opcional)**
```sql
-- Ejecutar como administrador de base de datos
@database_security_setup_admin.sql
```

**Este script crea:**
- ‚úÖ Vista `V_USUARIOS_CON_PAGO`
- ‚úÖ Sin√≥nimos `UPS` y `VUCP`
- ‚úÖ Permisos de lectura p√∫blica

### **Paso 3: Migraci√≥n de Contrase√±as (Opcional)**
```sql
-- Migrar contrase√±as existentes a Base64
@database_password_migration.sql
```

**Este script:**
- ‚úÖ Convierte contrase√±as en texto plano a Base64
- ‚úÖ Marca contrase√±as como codificadas
- ‚úÖ Verifica el estado de migraci√≥n

## üöÄ Verificaci√≥n de Instalaci√≥n

### **1. Verificar Tablas Creadas**
```sql
-- Verificar tabla de estados de pago
SELECT COUNT(*) FROM USER_PAYMENT_STATUS;

-- Verificar columnas nuevas en USUARIOS
SELECT COLUMN_NAME, DATA_TYPE 
FROM USER_TAB_COLUMNS 
WHERE TABLE_NAME = 'USUARIOS' 
AND COLUMN_NAME IN ('TWO_FACTOR_ENABLED', 'USER_ROLE', 'PASSWORD_ENCODED');
```

### **2. Verificar Usuario Super Admin**
```sql
-- Verificar usuario super admin
SELECT NO_USUARIO, NOMBRE_EMPLEADO, USER_ROLE, ESTATUS_USUARIO
FROM USUARIOS 
WHERE NO_USUARIO = 'SUPERADMIN';

-- Verificar estado de pago
SELECT NO_USUARIO, PAYMENT_STATUS, CREATED_AT
FROM USER_PAYMENT_STATUS 
WHERE NO_USUARIO = 'SUPERADMIN';
```

### **3. Verificar Funciones**
```sql
-- Probar funci√≥n de acceso
SELECT FN_USER_HAS_ACCESS('SUPERADMIN') FROM DUAL;
-- Debe retornar 'Y'
```

## üîê Configuraci√≥n del Sistema

### **1. Credenciales del Super Admin**
```
Usuario: SUPERADMIN
Contrase√±a: admin123
Rol: SUPER_ADMIN
Estado de Pago: PAID (siempre tiene acceso)
```

### **2. Estados de Pago Disponibles**
- `PAID` - Pagado (tiene acceso)
- `PENDING` - Pendiente (sin acceso)
- `OVERDUE` - Vencido (sin acceso)
- `SUSPENDED` - Suspendido (sin acceso)
- `CANCELLED` - Cancelado (sin acceso)

### **3. Roles del Sistema**
- `SUPER_ADMIN` - Control total (solo Cibercom)
- `ADMIN` - Gesti√≥n de usuarios
- `USER` - Usuario regular
- `OPERATOR` - Operador

## üõ†Ô∏è Soluci√≥n de Problemas

### **Error: "Tabla ya existe"**
```sql
-- Si la tabla ya existe, usar:
DROP TABLE USER_PAYMENT_STATUS CASCADE CONSTRAINTS;
-- Luego ejecutar el script nuevamente
```

### **Error: "Columna ya existe"**
```sql
-- Si las columnas ya existen, verificar:
SELECT COLUMN_NAME FROM USER_TAB_COLUMNS 
WHERE TABLE_NAME = 'USUARIOS' 
AND COLUMN_NAME IN ('TWO_FACTOR_ENABLED', 'USER_ROLE');
```

### **Error: "Usuario ya existe"**
```sql
-- Si el Super Admin ya existe:
UPDATE USUARIOS SET USER_ROLE = 'SUPER_ADMIN' 
WHERE NO_USUARIO = 'SUPERADMIN';
```

## üìä Pr√≥ximos Pasos

### **1. Compilar el Proyecto**
```bash
cd facturacion-backend/facturacion-back
mvn clean install
```

### **2. Probar Autenticaci√≥n**
```bash
# Login con Super Admin
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"usuario":"SUPERADMIN","password":"admin123"}'
```

### **3. Configurar 2FA (Opcional)**
```bash
# Configurar autenticaci√≥n en dos pasos
curl -X POST "http://localhost:8080/api/auth/2fa/setup?username=SUPERADMIN"
```

### **4. Gestionar Pagos**
```bash
# Ver estados de pago (solo Super Admin)
curl -X GET http://localhost:8080/api/admin/payment-status \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## ‚úÖ Estado Actual

- ‚úÖ **Base de datos**: Configurada correctamente
- ‚úÖ **Tablas**: Creadas exitosamente
- ‚úÖ **Usuario Super Admin**: Disponible
- ‚úÖ **C√≥digo Java**: Sin errores
- ‚úÖ **Funcionalidades**: Listas para usar

## üÜò Soporte

Si encuentras alg√∫n problema:

1. **Verificar logs del servidor**
2. **Comprobar conexi√≥n a base de datos**
3. **Validar configuraci√≥n JWT**
4. **Revisar permisos de usuario**

---

**Nota**: Los errores de permisos que obtuviste son normales y no afectan la funcionalidad principal del sistema. El script principal se ejecut√≥ correctamente y todas las funcionalidades est√°n disponibles.
