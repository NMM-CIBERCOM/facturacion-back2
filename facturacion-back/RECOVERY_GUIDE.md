# üîÑ Gu√≠a de Recuperaci√≥n Completa - Sin P√©rdida de Datos

## üö® Situaci√≥n Actual

No puedes acceder y no est√°s seguro si los roles anteriores siguen existiendo. He creado scripts seguros que **NO MODIFICAN** tus datos existentes, solo agregan lo necesario.

## üìã Plan de Recuperaci√≥n Segura

### **Paso 1: Verificar Estado Actual**
```sql
-- Ejecutar diagn√≥stico completo
@database_full_diagnostic.sql
```

**Este script te mostrar√°:**
- ‚úÖ Todos los perfiles/roles existentes
- ‚úÖ Todos los usuarios y sus perfiles actuales
- ‚úÖ Qu√© columnas nuevas existen o faltan
- ‚úÖ Estado de tablas, funciones e √≠ndices

### **Paso 2: Verificar Roles Anteriores**
```sql
-- Verificar espec√≠ficamente los roles anteriores
@database_check_roles.sql
```

**Este script te mostrar√°:**
- ‚úÖ Todos los perfiles en la tabla `PERFIL`
- ‚úÖ Qu√© usuarios tienen qu√© perfiles asignados
- ‚úÖ Si hay usuarios sin perfil o perfiles sin usuarios
- ‚úÖ Estad√≠sticas de uso de cada perfil

### **Paso 3: Recuperaci√≥n Segura**
```sql
-- Recuperar funcionalidad sin perder datos
@database_safe_recovery.sql
```

**Este script:**
- ‚úÖ **NO MODIFICA** datos existentes
- ‚úÖ Solo agrega columnas faltantes con valores por defecto
- ‚úÖ Crea tablas nuevas si no existen
- ‚úÖ Preserva todos los perfiles y usuarios existentes

## üîç ¬øQu√© Verificar Primero?

### **1. Verificar Perfiles Existentes**
```sql
-- Ver todos los perfiles que tienes
SELECT ID_PERFIL, NOMBRE_PERFIL, STATUS_PERFIL 
FROM PERFIL 
ORDER BY ID_PERFIL;
```

### **2. Verificar Usuarios y Sus Perfiles**
```sql
-- Ver usuarios y sus perfiles actuales
SELECT 
    u.NO_USUARIO,
    u.NOMBRE_EMPLEADO,
    u.ID_PERFIL,
    p.NOMBRE_PERFIL,
    u.ESTATUS_USUARIO
FROM USUARIOS u
LEFT JOIN PERFIL p ON u.ID_PERFIL = p.ID_PERFIL
ORDER BY u.NO_USUARIO;
```

### **3. Verificar Estado de Acceso**
```sql
-- Ver qu√© usuarios est√°n activos
SELECT 
    NO_USUARIO,
    NOMBRE_EMPLEADO,
    ESTATUS_USUARIO,
    ID_PERFIL
FROM USUARIOS
WHERE ESTATUS_USUARIO = 'A'
ORDER BY NO_USUARIO;
```

## üõ†Ô∏è Soluciones por Problema

### **Problema 1: No Existen las Columnas Nuevas**
**S√≠ntomas**: Error al ejecutar el c√≥digo Java
**Soluci√≥n**: El script `database_safe_recovery.sql` las crea autom√°ticamente

### **Problema 2: Usuarios Sin Estado de Pago**
**S√≠ntomas**: Usuarios no pueden acceder
**Soluci√≥n**: El script crea estados de pago por defecto (`PAID`)

### **Problema 3: Funci√≥n FN_USER_HAS_ACCESS No Existe**
**S√≠ntomas**: Error en consultas de acceso
**Soluci√≥n**: El script la crea autom√°ticamente

### **Problema 4: Usuario SUPERADMIN No Existe**
**S√≠ntomas**: No hay usuario de emergencia
**Soluci√≥n**: El script lo crea con credenciales `SUPERADMIN/admin123`

## üîê Credenciales de Emergencia

Despu√©s de ejecutar la recuperaci√≥n:

- **Usuario**: `SUPERADMIN`
- **Contrase√±a**: `admin123`
- **Rol**: `SUPER_ADMIN`
- **Acceso**: Siempre permitido

## üìä Verificaci√≥n Post-Recuperaci√≥n

### **1. Verificar que Todo Funciona**
```sql
-- Probar funci√≥n de acceso
SELECT FN_USER_HAS_ACCESS('SUPERADMIN') FROM DUAL;
-- Debe retornar 'Y'

-- Ver todos los usuarios con acceso
SELECT 
    u.NO_USUARIO,
    FN_USER_HAS_ACCESS(u.NO_USUARIO) AS TIENE_ACCESO
FROM USUARIOS u
WHERE u.ESTATUS_USUARIO = 'A';
```

### **2. Verificar Perfiles Preservados**
```sql
-- Verificar que los perfiles siguen igual
SELECT COUNT(*) AS TOTAL_PERFILES FROM PERFIL;
SELECT COUNT(*) AS PERFILES_ACTIVOS FROM PERFIL WHERE STATUS_PERFIL = 'A';
```

### **3. Verificar Usuarios Preservados**
```sql
-- Verificar que los usuarios siguen igual
SELECT COUNT(*) AS TOTAL_USUARIOS FROM USUARIOS;
SELECT COUNT(*) AS USUARIOS_ACTIVOS FROM USUARIOS WHERE ESTATUS_USUARIO = 'A';
```

## üöÄ Orden de Ejecuci√≥n Recomendado

1. **Primero**: `@database_full_diagnostic.sql`
2. **Segundo**: `@database_check_roles.sql`
3. **Tercero**: `@database_safe_recovery.sql`
4. **Cuarto**: Probar acceso con `SUPERADMIN/admin123`

## ‚ö†Ô∏è Importante

- ‚úÖ **Los scripts son seguros** - No modifican datos existentes
- ‚úÖ **Preservan todos los perfiles** - Solo agregan funcionalidad nueva
- ‚úÖ **Mantienen usuarios existentes** - Solo agregan campos necesarios
- ‚úÖ **Crean usuario de emergencia** - Para casos de problemas

## üîß Si A√∫n No Funciona

### **Verificar Logs del Servidor**
```bash
# Buscar errores espec√≠ficos
grep -i "error\|exception\|sql" logs/server.log
```

### **Probar Conexi√≥n Directa**
```sql
-- Probar consulta b√°sica
SELECT COUNT(*) FROM USUARIOS WHERE ESTATUS_USUARIO = 'A';
```

### **Verificar Configuraci√≥n Java**
- ‚úÖ `application.yml` tiene configuraci√≥n JWT
- ‚úÖ `UsuarioService.java` est√° actualizado
- ‚úÖ Dependencias JWT est√°n en `pom.xml`

---

**Ejecuta los scripts en orden y comparte los resultados. Los scripts te mostrar√°n exactamente qu√© est√° pasando sin modificar nada.**
