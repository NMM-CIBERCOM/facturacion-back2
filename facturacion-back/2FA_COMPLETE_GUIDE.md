# üîê Gu√≠a Completa - 2FA con Google Authenticator

## ‚úÖ Problemas Solucionados

1. **Conversi√≥n Base64 ‚Üí Base32**: Corregida la conversi√≥n para que Google Authenticator acepte la clave
2. **Frontend 2FA**: Agregado componente `TwoFactorAuthPage` y flujo completo en `App.tsx`

## üöÄ Pasos para Probar 2FA

### **Paso 1: Configurar Base de Datos**

```sql
-- Ejecutar en Oracle SQL Developer
@database_convert_base32_correct.sql
```

**Verificar que la clave tenga 32 caracteres:**
```sql
SELECT 
    NO_USUARIO,
    TWO_FACTOR_SECRET,
    LENGTH(TWO_FACTOR_SECRET) AS LONGITUD
FROM USUARIOS
WHERE NO_USUARIO = 'admin';
```

**Deber√≠a mostrar:**
- `TWO_FACTOR_SECRET`: `JN7XWRTG4NVWXJTS26DUCGY8QHU`
- `LONGITUD`: `32`

### **Paso 2: Configurar Google Authenticator**

1. **Abrir Google Authenticator**
2. **Tocar "Agregar cuenta"**
3. **Seleccionar "Introducir una clave de configuraci√≥n"**
4. **Ingresar:**
   - **Cuenta**: `Cibercom - admin`
   - **Clave**: `JN7XWRTG4NVWXJTS26DUCGY8QHU`
   - **Tipo**: "Basado en tiempo"
5. **Tocar "Agregar"**

### **Paso 3: Activar 2FA en Backend**

```bash
# Obtener c√≥digo actual de Google Authenticator (6 d√≠gitos)
curl -X POST "http://localhost:8080/api/auth/2fa/enable?username=admin&code=123456"
```

### **Paso 4: Probar Login con 2FA**

1. **Abrir la aplicaci√≥n frontend** (http://localhost:3000)
2. **Hacer login con:**
   - Usuario: `admin`
   - Contrase√±a: `admin`
3. **Deber√≠a aparecer la pantalla de 2FA**
4. **Ingresar el c√≥digo de 6 d√≠gitos** de Google Authenticator
5. **Tocar "Verificar C√≥digo"**

## üîß Archivos Modificados

### **Frontend:**
- ‚úÖ `components/TwoFactorAuthPage.tsx` - Nuevo componente para 2FA
- ‚úÖ `App.tsx` - Flujo completo de 2FA integrado

### **Backend:**
- ‚úÖ `database_convert_base32_correct.sql` - Conversi√≥n correcta Base64 ‚Üí Base32

## üß™ Pruebas con cURL

### **1. Login normal (deber√≠a requerir 2FA):**
```bash
curl -X POST "http://localhost:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"usuario":"admin","password":"admin"}'
```

**Respuesta esperada:**
```json
{
  "success": true,
  "message": "Autenticaci√≥n exitosa",
  "requiresTwoFactor": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "usuario": {
    "noUsuario": "admin",
    "nombreEmpleado": "Administrador Sistema Y",
    "idPerfil": 3,
    "nombrePerfil": "Administrador"
  }
}
```

### **2. Verificar c√≥digo 2FA:**
```bash
curl -X POST "http://localhost:8080/api/auth/2fa/verify" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "code": "123456",
    "sessionToken": "TOKEN_DEL_LOGIN"
  }'
```

**Respuesta esperada:**
```json
{
  "success": true,
  "message": "Autenticaci√≥n en dos pasos completada exitosamente",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "usuario": {
    "noUsuario": "admin",
    "nombreEmpleado": "Administrador Sistema Y",
    "idPerfil": 3,
    "nombrePerfil": "Administrador"
  }
}
```

## üéØ Flujo Completo en Frontend

1. **Usuario ingresa credenciales** ‚Üí Login normal
2. **Backend responde con `requiresTwoFactor: true`** ‚Üí Muestra pantalla 2FA
3. **Usuario ingresa c√≥digo de Google Authenticator** ‚Üí Verificaci√≥n
4. **Backend valida c√≥digo** ‚Üí Login completo
5. **Usuario accede a la aplicaci√≥n** ‚Üí Dashboard

## üîç Verificaci√≥n de Estado

### **En Base de Datos:**
```sql
SELECT 
    NO_USUARIO,
    TWO_FACTOR_ENABLED,
    TWO_FACTOR_SECRET,
    CASE 
        WHEN TWO_FACTOR_ENABLED = 'Y' THEN '‚úÖ 2FA ACTIVO'
        WHEN TWO_FACTOR_ENABLED = 'N' AND TWO_FACTOR_SECRET IS NOT NULL THEN '‚öôÔ∏è PENDIENTE DE ACTIVAR'
        ELSE '‚ùå 2FA NO CONFIGURADO'
    END AS ESTADO_2FA
FROM USUARIOS
WHERE NO_USUARIO = 'admin';
```

### **En Frontend:**
- Abrir DevTools (F12)
- Verificar que aparezca la pantalla de 2FA despu√©s del login
- Verificar que el c√≥digo se env√≠e correctamente al backend

## üö® Soluci√≥n de Problemas

### **Error: "Clave demasiado corta"**
- ‚úÖ **Solucionado**: Usar `database_convert_base32_correct.sql`

### **Error: "C√≥digo de verificaci√≥n inv√°lido"**
- Verificar que el c√≥digo de Google Authenticator sea el m√°s reciente (cambia cada 30 segundos)
- Verificar que la clave en la BD sea correcta (32 caracteres Base32)

### **No aparece pantalla de 2FA**
- Verificar que `TWO_FACTOR_ENABLED = 'Y'` en la base de datos
- Verificar que el backend est√© devolviendo `requiresTwoFactor: true`

---

**¬°El 2FA est√° completamente implementado y listo para usar!** üéâ
