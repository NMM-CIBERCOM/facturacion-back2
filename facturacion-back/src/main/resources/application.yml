# ============================================================================
# CONFIGURACIÓN BASE - Valores comunes para todos los perfiles
# Perfil activo por defecto: local,oracle (Oracle en tu PC).
# Servidor (Oracle en Docker): --spring.profiles.active=dev,oracle
# Producción (Oracle remoto): --spring.profiles.active=prod,oracle
# ============================================================================
spring:
  profiles:
    active: local,oracle
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB
  jackson:
    serialization:
      write-dates-as-timestamps: false
    date-format: yyyy-MM-dd'T'HH:mm:ss.SSS
  mail:
    host: smtp.gmail.com
    port: 587
    username: nm9282672@gmail.com
    password: kaswbavrfmlqenec
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
          from: nm9282672@gmail.com
  main:
    headless: false

# Configuración de logs para preview y escritura
app:
  logs:
    # Base directory that contains readable log files for previewing.
    # You can override with environment variable LOGS_BASE_DIR.
    # Example (Linux): /var/log/myapp
    # Example (Windows): C:/cibercom/logs
    # Por defecto usa Linux, pero puede sobrescribirse con variable de entorno
    base-dir: "${LOGS_BASE_DIR:/var/log/facturacion}"
    # Allow clients to pass ?baseDir=... in requests (dev convenience)
    allow-request-base: ${ALLOW_REQUEST_BASE:true}

# Escribir logs del backend en la misma carpeta para que aparezcan en la UI
logging:
  file:
    name: ${LOG_FILE:${app.logs.base-dir}/server.log}
  logback:
    rollingpolicy:
      # Rota por fecha y tamaño: server.log.2025-10-23.0, .1, ...
      file-name-pattern: ${app.logs.base-dir}/server.log.%d{yyyy-MM-dd}.%i
      max-file-size: 10MB
      max-history: 7
      total-size-cap: 200MB


# Configuración JWT
jwt:
  secret: cibercom-facturacion-secret-key-2024-super-secure
  expiration: 900000 # 15 minutos en milisegundos

# Configuración de seguridad
security:
  cors:
    allowed-origins: http://localhost:5173
    allowed-methods: GET,POST,PUT,DELETE,OPTIONS
    allowed-headers: "*"
    allow-credentials: true

# Configuración del Emisor (valores por defecto para CFDI)
facturacion:
  emisor:
    rfc: IVD920810GU2
    nombre: INNOVACION VALOR Y DESARROLLO SA
    regimen: 601
    cp: 58000
    registroPatronal: "VADA800927HSRSRL05"  # Registro Patronal del IMSS (requerido para nóminas)
  csd:
    enabled: true
    certificado:
      path: classpath:certificados/CSD_Sucursal_1_IVD920810GU2_20230518_062554.cer
    llave:
      path: classpath:certificados/CSD_Sucursal_1_IVD920810GU2_20230518_062554.key
      password: "12345678a"

# Configuración de Finkok (PAC) - Demo por defecto
finkok:
  enabled: true
  username: nm9282672@gmail.com
  password: N1C0LASm_  # Esta contraseña se usa para encriptar la llave privada en DES3
  stamp:
    url: https://demo-facturacion.finkok.com/servicios/soap/stamp
  cancel:
    url: https://demo-facturacion.finkok.com/servicios/soap/cancel
  retentions:
    url: https://demo-facturacion.finkok.com/servicios/soap/retentions
  # Configuración de proxy (opcional - descomentar y configurar si necesitas proxy)
  # proxy:
  #   enabled: false
  #   host: proxy.example.com
  #   port: 8080
  # Configuración avanzada de conexión
  connection:
    connect-timeout: 15000  # 15 segundos (reducido para fallar más rápido si hay problemas de red)
    read-timeout: 30000     # 30 segundos (reducido para fallar más rápido)
    use-ipv4-only: true     # Forzar IPv4 para evitar problemas con IPv6
    follow-redirects: true  # Seguir redirecciones
  # Configuración de túnel SSH (para evitar bloqueos de firewall)
  tunnel:
    enabled: false          # Habilitar si usas túnel SSH (ver SOLUCION_TUNEL_SSH.md)
    local-port: 8443        # Puerto local del túnel SSH
    # Cuando tunnel.enabled=true, las URLs se cambian automáticamente a localhost:8443

# ============================================================================
# PERFIL: LOCAL (local) - Al correr en tu PC, conecta al Oracle del servidor 72.
# Si tuvieras Oracle en tu PC, cambia la url a localhost:1521/XEPDB1.
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: local
  datasource:
    # Oracle en el servidor 72 (Docker). El puerto 1521 debe estar accesible desde tu red.
    url: jdbc:oracle:thin:@//72.62.128.98:1521/XEPDB1
    username: nick
    password: password123
    driver-class-name: oracle.jdbc.OracleDriver
    hikari:
      connection-timeout: 30000
      maximum-pool-size: 10
      minimum-idle: 2
      max-lifetime: 1800000
      idle-timeout: 600000
      validation-timeout: 5000
      leak-detection-threshold: 60000
      initialization-fail-timeout: -1
      connection-test-query: SELECT 1 FROM DUAL
      keepalive-time: 300000
  jpa:
    properties:
      hibernate.dialect: org.hibernate.dialect.OracleDialect
      hibernate.temp.use_jdbc_metadata_defaults: false
    hibernate:
      ddl-auto: none
    open-in-view: false
  show-sql: true
server:
  port: 8080
  base-url: http://localhost:8080
cors:
  allowed-origins: http://localhost:5173,http://localhost:5174,http://127.0.0.1:5173,http://127.0.0.1:5174
finkok:
  enabled: true
  username: nm9282672@gmail.com
  password: N1C0LASm_
  stamp:
    url: https://demo-facturacion.finkok.com/servicios/soap/stamp
  cancel:
    url: https://demo-facturacion.finkok.com/servicios/soap/cancel
  retentions:
    url: https://demo-facturacion.finkok.com/servicios/soap/retentions

# ============================================================================
# PERFIL: DEV (dev) - Oracle en Docker en el servidor 72 (Tomcat usa este)
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: dev
  # Base de datos Oracle para desarrollo en servidor (Docker)
  datasource:
    url: jdbc:oracle:thin:@//localhost:1521/XEPDB1
    username: nick
    password: password123
    driver-class-name: oracle.jdbc.OracleDriver
    # Configuración del pool de conexiones (HikariCP)
    hikari:
      connection-timeout: 30000
      maximum-pool-size: 10
      minimum-idle: 2
      max-lifetime: 1800000  # 30 minutos (Oracle recomienda menos que el timeout de la BD)
      idle-timeout: 600000   # 10 minutos
      validation-timeout: 5000
      leak-detection-threshold: 60000
      # No validar la conexión al inicio (permite que la app inicie aunque Oracle no esté disponible)
      initialization-fail-timeout: -1
      # Intentar conexión solo cuando se necesite, no al inicio
      connection-test-query: SELECT 1 FROM DUAL
      # Configuración específica para Oracle
      keepalive-time: 300000  # 5 minutos - mantiene conexiones vivas
  jpa:
    properties:
      hibernate.dialect: org.hibernate.dialect.OracleDialect
      # Hacer JPA más tolerante cuando la BD no está disponible
      hibernate.temp.use_jdbc_metadata_defaults: false
    hibernate:
      ddl-auto: none
    # No inicializar JPA hasta que se necesite (permite iniciar sin BD)
    open-in-view: false
  show-sql: true

# Servidor para desarrollo local
server:
  port: 8080
  # Sin context-path en desarrollo (Spring Boot embebido)
  base-url: http://localhost:8080

# URLs permitidas para CORS (desarrollo) - separadas por comas
cors:
  allowed-origins: http://localhost:5173,http://localhost:5174,http://127.0.0.1:5173,http://127.0.0.1:5174

# Finkok en modo demo para desarrollo
finkok:
  enabled: true
  username: nm9282672@gmail.com
  password: N1C0LASm_
  stamp:
    url: https://demo-facturacion.finkok.com/servicios/soap/stamp
  cancel:
    url: https://demo-facturacion.finkok.com/servicios/soap/cancel
  retentions:
    url: https://demo-facturacion.finkok.com/servicios/soap/retentions

# ============================================================================
# PERFIL: PRODUCCIÓN (prod) - Configuración para producción
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: prod
  # Base de datos Oracle para producción
  datasource:
    url: jdbc:oracle:thin:@//174.136.25.157:1521/XE
    username: nick
    password: N1C0LASm
    driver-class-name: oracle.jdbc.OracleDriver
    # Configuración del pool de conexiones (HikariCP)
    hikari:
      connection-timeout: 30000
      maximum-pool-size: 10
      minimum-idle: 2
      max-lifetime: 1800000  # 30 minutos (Oracle recomienda menos que el timeout de la BD)
      idle-timeout: 600000   # 10 minutos
      validation-timeout: 5000
      leak-detection-threshold: 60000
      connection-test-query: SELECT 1 FROM DUAL
      # Configuración específica para Oracle
      keepalive-time: 300000  # 5 minutos - mantiene conexiones vivas
  jpa:
    properties:
      hibernate.dialect: org.hibernate.dialect.OracleDialect
    hibernate:
      ddl-auto: none
  show-sql: false

# Servidor para producción
server:
  port: 8080
  servlet:
    # Context path del WAR en Tomcat (debe coincidir con el nombre del WAR sin extensión)
    # Si el WAR se llama facturacion-backend.war, el context-path será /facturacion-backend
    context-path: /facturacion-backend
  base-url: http://72.62.128.98:8080

# URLs permitidas para CORS (producción) - separadas por comas
# Como el frontend estará en el mismo servidor, permitir el mismo dominio
cors:
  allowed-origins: http://72.62.128.98:8080,http://localhost:8080,http://localhost:5173,http://localhost:5174

# Finkok en producción (puede usar demo o producción según necesidad)
finkok:
  enabled: true
  username: nm9282672@gmail.com
  password: N1C0LASm_
  stamp:
    url: https://demo-facturacion.finkok.com/servicios/soap/stamp
  # Configuración de conexión
  connection:
    connect-timeout: 60000  # 60 segundos
    read-timeout: 180000    # 180 segundos
    use-ipv4-only: true     # Forzar IPv4
    follow-redirects: true   # Seguir redirecciones
  cancel:
    url: https://demo-facturacion.finkok.com/servicios/soap/cancel
  retentions:
    url: https://demo-facturacion.finkok.com/servicios/soap/retentions

# ============================================================================
# PERFIL: ORACLE (oracle) - Configuración específica de Oracle DB
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: oracle

# ============================================================================
# PERFIL: MONGO (mongo) - Configuración específica de MongoDB (opcional)
# ============================================================================
---
spring:
  config:
    activate:
      on-profile: mongo
  data:
    mongodb:
      uri: mongodb://localhost:27017/facturacion_mongo
