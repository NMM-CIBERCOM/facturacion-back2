# üîß Soluci√≥n de Problemas - Acceso Denegado

## üö® Problema Identificado

No puedes acceder ni con las nuevas credenciales ni con las existentes. Esto puede deberse a varios factores:

## üìã Pasos de Diagn√≥stico

### **Paso 1: Ejecutar Diagn√≥stico de Base de Datos**
```sql
-- Ejecutar este script para verificar el estado
@database_diagnostic.sql
```

### **Paso 2: Corregir Usuarios Existentes**
```sql
-- Ejecutar este script para corregir problemas
@database_fix_users.sql
```

### **Paso 3: Probar Autenticaci√≥n**
```sql
-- Ejecutar este script para verificar acceso
@database_test_auth.sql
```

## üîç Posibles Causas del Problema

### **1. Columnas Nuevas No Existen**
- Las columnas `USER_ROLE`, `PASSWORD_ENCODED`, etc. pueden no haberse creado
- **Soluci√≥n**: Ejecutar `database_security_setup_simple.sql` nuevamente

### **2. Usuarios Sin Estado de Pago**
- Los usuarios existentes no tienen registro en `USER_PAYMENT_STATUS`
- **Soluci√≥n**: El script `database_fix_users.sql` los crea autom√°ticamente

### **3. Contrase√±as Codificadas Incorrectamente**
- Las contrase√±as pueden estar en formato incorrecto
- **Soluci√≥n**: Verificar el tipo de codificaci√≥n

### **4. Estado de Usuario Incorrecto**
- El campo `ESTATUS_USUARIO` puede no ser 'A' (Activo)
- **Soluci√≥n**: Actualizar a 'A'

## üõ†Ô∏è Soluciones R√°pidas

### **Soluci√≥n 1: Crear Usuario de Prueba Simple**
```sql
-- Crear usuario de prueba con contrase√±a simple
INSERT INTO USUARIOS (
    NO_USUARIO, NOMBRE_EMPLEADO, PASSWORD, ESTATUS_USUARIO, ID_PERFIL, 
    FECHA_ALTA, FECHA_MOD, USUARIO_MOD, ID_DFI, ID_ESTACIONAMIENTO, 
    MODIFICA_UBICACION, USER_ROLE, PASSWORD_ENCODED
) VALUES (
    'TEST', 'Usuario de Prueba', 'test123', 'A', 1,
    SYSDATE, SYSDATE, 'SYSTEM', 1, 1,
    'N', 'USER', 'N'
);

-- Crear estado de pago
INSERT INTO USER_PAYMENT_STATUS (
    NO_USUARIO, PAYMENT_STATUS, CREATED_AT, UPDATED_AT, UPDATED_BY
) VALUES (
    'TEST', 'PAID', SYSDATE, SYSDATE, 'SYSTEM'
);

COMMIT;
```

### **Soluci√≥n 2: Verificar Credenciales del Super Admin**
```sql
-- Verificar contrase√±a del Super Admin
SELECT 
    NO_USUARIO,
    PASSWORD,
    PASSWORD_ENCODED,
    ESTATUS_USUARIO,
    USER_ROLE
FROM USUARIOS 
WHERE NO_USUARIO = 'SUPERADMIN';
```

### **Soluci√≥n 3: Resetear Contrase√±a del Super Admin**
```sql
-- Resetear contrase√±a del Super Admin a texto plano
UPDATE USUARIOS 
SET PASSWORD = 'admin123',
    PASSWORD_ENCODED = 'N',
    USER_ROLE = 'SUPER_ADMIN',
    ESTATUS_USUARIO = 'A'
WHERE NO_USUARIO = 'SUPERADMIN';

COMMIT;
```

## üß™ Pruebas de Acceso

### **Prueba 1: Verificar Usuario Existe**
```sql
SELECT COUNT(*) FROM USUARIOS WHERE NO_USUARIO = 'SUPERADMIN' AND ESTATUS_USUARIO = 'A';
-- Debe retornar 1
```

### **Prueba 2: Verificar Contrase√±a**
```sql
SELECT PASSWORD FROM USUARIOS WHERE NO_USUARIO = 'SUPERADMIN';
-- Debe mostrar la contrase√±a (admin123 si es texto plano)
```

### **Prueba 3: Verificar Estado de Pago**
```sql
SELECT PAYMENT_STATUS FROM USER_PAYMENT_STATUS WHERE NO_USUARIO = 'SUPERADMIN';
-- Debe retornar 'PAID'
```

### **Prueba 4: Verificar Funci√≥n de Acceso**
```sql
SELECT FN_USER_HAS_ACCESS('SUPERADMIN') FROM DUAL;
-- Debe retornar 'Y'
```

## üîß C√≥digo Java Corregido

He actualizado el `UsuarioService.java` para ser m√°s robusto:

- ‚úÖ **Consulta simplificada**: Solo campos que siempre existen
- ‚úÖ **RowMapper robusto**: Maneja columnas opcionales
- ‚úÖ **Manejo de errores**: Mejor logging de problemas

## üìû Pr√≥ximos Pasos

1. **Ejecutar scripts de diagn√≥stico** en orden
2. **Verificar logs del servidor** para errores espec√≠ficos
3. **Probar con usuario simple** (TEST/test123)
4. **Verificar configuraci√≥n JWT** en application.yml

## üÜò Si A√∫n No Funciona

### **Verificar Logs del Servidor**
```bash
# Buscar errores en los logs
grep -i "error\|exception" logs/server.log
```

### **Probar Endpoint Directamente**
```bash
# Probar login con curl
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"usuario":"SUPERADMIN","password":"admin123"}'
```

### **Verificar Conexi√≥n a Base de Datos**
```bash
# Verificar que la aplicaci√≥n se conecta a Oracle
grep -i "oracle\|database" logs/server.log
```

---

**Nota**: Los scripts de diagn√≥stico te mostrar√°n exactamente qu√© est√° causando el problema. Ejec√∫talos en orden y comparte los resultados.
